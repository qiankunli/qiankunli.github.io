---

layout: post
title: tcp ip socket
category: 技术
tags: Other
keywords: tcp ip socket

---

## 前言 ##

TCP/IP不是一个协议，而是一个协议族的统称，里面包括了IP协议、IMCP协议、TCP协议以及我们更加熟悉的http、ftp、pop3协议等等。

TCP/IP协议族按照层次由上到下，层层包装。发送协议的主机从上自下将数据按照协议封装，而接收数据的主机则按照协议从得到的数据包解开，最后拿到需要的数据。这种结构非常有栈的味道，所以某些文章也把tcp/ip协议族称为**tcp/ip协议栈**。

**什么是端口号(port)？**

注意，这个号码是用在TCP，UDP上的一个逻辑号码，并不是一个硬件端口，我们平时说把某某端口封掉了，也只是在IP层次把带有这个号码的IP包给过滤掉了而已。

Socket 是一个**编程接口**，（linux tcp/ip协议栈的实现通常有一个socket层），包括几个最基本的函数接口。比如create、listen、accept、connect、read和write等等。Socket可以支持不同的传输层协议（TCP或UDP ），Socket跟TCP/IP 并没有必然的联系，socket的出现只是可以更方便的使用TCP/IP 协议栈（注意，这个协议栈虽然以tcp/ip命名，但不仅是这两个协议）而已。 

## 面向连接和无连接

连接是对状态的保持，实际上就是在客户端和服务器端都维护一个变量，这个变量维护现在数据传输的状态，例如传输了哪些数据，下一次需要传输哪些数据，等等，并不是真的我们想象中的真的有什么东西连接着这两端，因为无论对于有连接还是无连接，都有网线连着呢。

UDP通讯有四个参数：源IP、源端口、目的IP和目的端口。而TCP通讯至少有有六个参数：源IP、源端口、目的IP和目的端口，以及序列号和应答号。
序列号和应答号是TCP通讯特有的参数，TCP通讯利用序列号和应答号来保持和确认数据的关联与正确性。

TCP保证可靠，面向连接而UDP不保证可靠，非面向连接，UDP的报头长度远远小于TCP的报头长度。TCP使用了三种基础机制来实现面向连接的服务：

1. 使用序列号进行标记，以便TCP接收服务在向目的应用传递数据之前修正错序的报文排序；
2. TCP使用确认，校验，和定时器系统提供可靠性。
3. TCP在应用层数据上附加了一个报头，报头包括序列号字段和这些机制的其他一些必要信息，如叫做端口号的地址字段，该字段可以标识数据的源点和目标应用程序。


## “聪明的”tcp/ip

**Sliding Window：**TCP头里有一个字段叫Window，又叫Advertised-Window，这个字段是接收端告诉发送端自己还有多少缓冲区可以接收数据。于是发送端就可以根据这个接收端的处理能力来发送数据，而不会导致接收端处理不过来。

**拥塞控制：**TCP通过Sliding Window来做流控（Flow Control），但是TCP觉得这还不够，因为Sliding Window需要依赖于连接的发送端和接收端，其并不知道网络中间发生了什么。

如果网络上的延时突然增加，那么，TCP对这个事做出的应对只有重传数据，但是，重传会导致网络的负担更重，于是会导致更大的延迟以及更多的丢包，于是，这个情况就会进入恶性循环被不断地放大。试想一下，如果一个网络内有成千上万的TCP连接都这么行事，那么马上就会形成“网络风暴”，TCP这个协议就会拖垮整个网络。

拥塞控制主要是四个算法：1）慢启动，2）拥塞避免，3）拥塞发生，4）快速恢复。这四个算法不是一天都搞出来的，这个四算法的发展经历了很多时间，到今天都还在优化中。


## tcp连接建立与释放

tcp为了数据通信的可靠性，增加了很多操作（比如数据通信前后，要建立和释放连接），不像udp直接把包发出去就可以。


三次握手（从程序层面看，大致对应socket.connect函数）

1. 客户端向服务器发送连接请求，
2. 服务端向客户端发送确认
3. 客户端收到服务端确认后，向服务端发送确认

**为什么一定要进行三次握手呢？**

 前两次的握手很显然是必须的，主要是最后一次，即客户端收到服务端发来的确认后为什么还要向服务端再发送一次确认呢？这主要是为了防止已失效的请求报文段突然又传送到了服务端而产生连接的误判。

   考虑如下的情况：客户端发送了一个连接请求报文段到服务端，但是在某些网络节点上长时间滞留了，而后客户端又超时重发了一个连接请求报文段该服务端，而后正常建立连接，数据传输完毕，并释放了连接。如果这时候第一次发送的请求报文段延迟了一段时间后，又到了服务端，很显然，这本是一个早已失效的报文段，但是服务端收到后会误以为客户端又发出了一次连接请求，于是向客户端发出确认报文段，并同意建立连接。假设不采用三次握手，这时服务端只要发送了确认，新的连接就建立了，但由于客户端比你更没有发出建立连接的请求，因此不会理会服务端的确认，也不会向服务端发送数据，而服务端却认为新的连接已经建立了，并在一直等待客户端发送数据，这样服务端就会一直等待下去，直到超出保活计数器的设定值，而将客户端判定为出了问题，才会关闭这个连接。这样就浪费了很多服务器的资源。而如果采用三次握手，客户端就不会向服务端发出确认，服务端由于收不到确认，就知道客户端没有要求建立连接，从而不建立该连接。

## 数据库连接

Java 数据库连接，（Java Database Connectivity，简称JDBC）是Java语言中用来规范客户端程序如何来访问数据库的应用程序接口，提供了诸如查询和更新数据库中数据的方法。

此处，**连接**的概念与网络编程中的socket很像。**屏蔽通信细节，提供操作数据的方法**，但因为客户端和数据库连接的操作模式比较确定，java提供的接口自然也比较上层、方便。


## 未完成

## 引用

[TCP面向连接中的“连接”究竟是什么，可靠与不可靠](http://blog.csdn.net/haizhongyun/article/details/7621199 "")

[TCP连接的建立和释放](http://blog.csdn.net/ns_code/article/details/29382883 "")